name: Supabase Keep-Alive

on:
  schedule:
    # Runs at 00:00 UTC every 3 days
    - cron: "0 0 */3 * *"
  workflow_dispatch:

jobs:
  ping-database:
    runs-on: ubuntu-latest
    steps:
      - name: Install PostgreSQL Client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Ping Database with INSERT
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: |
          if [ -z "$SUPABASE_DB_URL" ]; then
            echo "Error: SUPABASE_DB_URL secret is not set."
            exit 1
          fi
          # Create table if it doesn't exist and insert a keep-alive record
          psql "$SUPABASE_DB_URL" -c "
            CREATE TABLE IF NOT EXISTS keep_alive (
              id SERIAL PRIMARY KEY,
              pinged_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
            );
            INSERT INTO keep_alive (pinged_at) VALUES (NOW());
            DELETE FROM keep_alive WHERE pinged_at < NOW() - INTERVAL '30 days';
          "
          echo "Database pinged successfully at $(date)"
